<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>WEB-STRIKE: TITAN ELITE | FINAL BUILD</title>
    <style>
        :root { --primary: #eebc51; --bg: #0b0c0e; --hud-bg: rgba(10, 15, 20, 0.9); }
        body, html { margin: 0; padding: 0; overflow: hidden; background: var(--bg); font-family: 'Courier New', monospace; color: white; }
        
        /* EFECTOS VISUALES */
        #vignette { position: fixed; inset: 0; pointer-events: none; z-index: 100; box-shadow: inset 0 0 150px rgba(0,0,0,0.9); transition: box-shadow 0.1s; }
        #grain { position: fixed; inset: 0; pointer-events: none; z-index: 101; opacity: 0.04; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E"); }

        /* HUD */
        #hud { position: fixed; inset: 0; pointer-events: none; z-index: 50; display: none; }
        .skew { transform: skewX(-10deg); background: var(--hud-bg); border-left: 4px solid var(--primary); padding: 10px 20px; position: absolute; }
        #health-info { bottom: 20px; left: 20px; }
        #score-info { top: 20px; left: 20px; }
        #weapon-info { bottom: 20px; right: 20px; text-align: right; }
        
        #crosshair { position: absolute; top: 50%; left: 50%; width: 20px; height: 20px; transform: translate(-50%, -50%); }
        #crosshair::before { content: ''; position: absolute; background: var(--primary); width: 2px; height: 100%; left: 9px; }
        #crosshair::after { content: ''; position: absolute; background: var(--primary); height: 2px; width: 100%; top: 9px; }

        /* MENÚ */
        #menu { position: fixed; inset: 0; z-index: 150; background: radial-gradient(circle, #1a2533 0%, #0b0c0e 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .btn { border: 2px solid var(--primary); color: var(--primary); padding: 20px 60px; cursor: pointer; font-weight: bold; letter-spacing: 3px; transition: 0.3s; }
        .btn:hover { background: var(--primary); color: #000; box-shadow: 0 0 30px var(--primary); }
    </style>
</head>
<body>

<div id="vignette"></div>
<div id="grain"></div>

<div id="menu">
    <h1 style="color: var(--primary); font-size: 3.5rem; margin: 0;">WEB-STRIKE</h1>
    <p style="letter-spacing: 5px; margin-bottom: 40px;">TITAN ELITE PROTOCOL</p>
    <div class="btn" onclick="startGame()">INICIAR OPERACIÓN</div>
</div>

<div id="hud">
    <div id="score-info" class="skew">BAJAS: <span id="kill-count">0</span></div>
    <div id="health-info" class="skew">VITALIDAD: <span id="hp-display">100</span>%</div>
    <div id="weapon-info" class="skew">ARMA: AK-47 PROTOTIPO<br>ESTADO: LISTO</div>
    <div id="crosshair"></div>
</div>

<script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';

    // --- MOTOR DE AUDIO ---
    class AudioEngine {
        static ctx = new (window.AudioContext || window.webkitAudioContext)();
        static playShot() {
            const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
            o.type = 'sawtooth'; o.frequency.setValueAtTime(150, this.ctx.currentTime);
            g.gain.setValueAtTime(0.1, this.ctx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.1);
            o.connect(g); g.connect(this.ctx.destination);
            o.start(); o.stop(this.ctx.currentTime + 0.1);
        }
        static playHeal() {
            const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
            o.frequency.setValueAtTime(400, this.ctx.currentTime);
            o.frequency.exponentialRampToValueAtTime(800, this.ctx.currentTime + 0.2);
            g.gain.setValueAtTime(0.1, this.ctx.currentTime);
            o.connect(g); g.connect(this.ctx.destination);
            o.start(); o.stop(this.ctx.currentTime + 0.2);
        }
    }

    // --- VARIABLES GLOBALES ---
    let scene, camera, renderer, clock, raycaster;
    let playerHP = 100, kills = 0, gunGroup;
    let enemies = [], medkits = [];
    const move = { w: false, s: false, a: false, d: false };
    const velocity = new THREE.Vector3();

    function init() {
        scene = new THREE.Scene();
        scene.fog = new THREE.Fog(0x0b0c0e, 0, 80);
        camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.rotation.order = 'YXZ'; // IMPORTANTE para rotación FPS estándar

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        clock = new THREE.Clock();
        raycaster = new THREE.Raycaster();

        // Escenario
        const floor = new THREE.Mesh(new THREE.PlaneGeometry(200, 200), new THREE.MeshStandardMaterial({ color: 0x151515 }));
        floor.rotation.x = -Math.PI/2;
        scene.add(floor);
        
        scene.add(new THREE.AmbientLight(0xffffff, 0.4));
        const sun = new THREE.PointLight(0xeebc51, 150);
        sun.position.set(0, 20, 0);
        scene.add(sun);

        // Obstáculos (Muros)
        for(let i=0; i<15; i++) {
            const h = Math.random() * 5 + 2;
            const wall = new THREE.Mesh(new THREE.BoxGeometry(4, h, 4), new THREE.MeshStandardMaterial({ color: 0x222222 }));
            wall.position.set((Math.random()-0.5)*80, h/2, (Math.random()-0.5)*80);
            scene.add(wall);
        }

        buildGun();
        setupControls();
        setInterval(spawnEnemy, 2500);
        setInterval(spawnMedkit, 12000);
        animate();
    }

    function buildGun() {
        gunGroup = new THREE.Group();
        const body = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.15, 0.7), new THREE.MeshStandardMaterial({ color: 0x111111 }));
        const barrel = new THREE.Mesh(new THREE.CylinderGeometry(0.02, 0.02, 0.5), new THREE.MeshStandardMaterial({ color: 0x000000 }));
        barrel.rotation.x = Math.PI/2; barrel.position.z = -0.5;
        gunGroup.add(body, barrel);
        gunGroup.position.set(0.35, -0.35, -0.6);
        camera.add(gunGroup);
        scene.add(camera);
    }

    function spawnEnemy() {
        const mesh = new THREE.Mesh(new THREE.BoxGeometry(1.2, 2.2, 1.2), new THREE.MeshStandardMaterial({ color: 0xff3333 }));
        const angle = Math.random() * Math.PI * 2;
        mesh.position.set(Math.cos(angle)*45, 1.1, Math.sin(angle)*45);
        mesh.userData = { isEnemy: true };
        scene.add(mesh);
        enemies.push(mesh);
    }

    function spawnMedkit() {
        const mesh = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.8, 0.8), new THREE.MeshStandardMaterial({ color: 0xffffff }));
        mesh.position.set((Math.random()-0.5)*50, 0.4, (Math.random()-0.5)*50);
        mesh.userData = { isMedkit: true };
        scene.add(mesh);
        medkits.push(mesh);
    }

    function setupControls() {
        window.startGame = () => { 
            document.getElementById('menu').style.display='none'; 
            document.getElementById('hud').style.display='block'; 
            document.body.requestPointerLock(); 
        };

        document.addEventListener('keydown', (e) => { if(move.hasOwnProperty(e.key.toLowerCase())) move[e.key.toLowerCase()] = true; });
        document.addEventListener('keyup', (e) => { if(move.hasOwnProperty(e.key.toLowerCase())) move[e.key.toLowerCase()] = false; });

        document.addEventListener('mousemove', (e) => {
            if (document.pointerLockElement === document.body) {
                // Rotación horizontal (Y) y vertical (X) corregida
                camera.rotation.y -= e.movementX * 0.002;
                let newX = camera.rotation.x - e.movementY * 0.002;
                camera.rotation.x = Math.max(-1.5, Math.min(1.5, newX));
            }
        });

        document.addEventListener('mousedown', () => {
            if(!document.pointerLockElement) return;
            AudioEngine.playShot();
            gunGroup.position.z += 0.05; // Retroceso visual

            raycaster.setFromCamera(new THREE.Vector2(0,0), camera);
            const hits = raycaster.intersectObjects(scene.children);
            if(hits.length > 0 && hits[0].object.userData.isEnemy) {
                scene.remove(hits[0].object);
                enemies = enemies.filter(e => e !== hits[0].object);
                kills++; document.getElementById('kill-count').innerText = kills;
            }
        });
    }

    function animate() {
        requestAnimationFrame(animate);
        const delta = clock.getDelta();
        if(!document.pointerLockElement) return;

        // Movimiento Jugador
        velocity.set(0,0,0);
        if(move.w) velocity.z -= 14 * delta; if(move.s) velocity.z += 14 * delta;
        if(move.a) velocity.x -= 14 * delta; if(move.d) velocity.x += 14 * delta;
        camera.translateX(velocity.x); camera.translateZ(velocity.z);
        camera.position.y = 1.7;

        // Efecto visual del arma
        gunGroup.position.z = THREE.MathUtils.lerp(gunGroup.position.z, -0.6, 0.1);
        gunGroup.position.y = -0.35 + Math.sin(Date.now() * 0.005) * 0.005;

        // Enemigos: IA y Daño
        enemies.forEach(en => {
            const dir = new THREE.Vector3().subVectors(camera.position, en.position).normalize();
            en.position.add(new THREE.Vector3(dir.x, 0, dir.z).multiplyScalar(4.5 * delta));
            en.lookAt(camera.position.x, 1.1, camera.position.z);
            
            if(en.position.distanceTo(camera.position) < 2) {
                playerHP -= 0.4;
                document.getElementById('vignette').style.boxShadow = "inset 0 0 150px rgba(255,0,0,0.7)";
                setTimeout(() => document.getElementById('vignette').style.boxShadow = "inset 0 0 150px rgba(0,0,0,0.9)", 50);
            }
        });

        // Botiquines
        medkits.forEach((m, i) => {
            m.rotation.y += 0.02;
            if(m.position.distanceTo(camera.position) < 2) {
                playerHP = Math.min(100, playerHP + 40);
                AudioEngine.playHeal();
                scene.remove(m); medkits.splice(i, 1);
            }
        });

        if(playerHP <= 0) { alert("MISION FALLIDA. BAJAS: " + kills); location.reload(); }
        document.getElementById('hp-display').innerText = Math.floor(playerHP);
        renderer.render(scene, camera);
    }

    init();
</script>
</body>
</html>